<section class="pb">
  <article class="pb-intro">
    <div [innerHTML]="intro$ | async | jpSanitize"></div>
    <button mat-stroked-button (click)="open()">{{'PB.START' | transloco}}</button>
  </article>

  <ng-container *ngIf="isOpen">
    <aside class="pb-sidebar" [class.fullscreen]="isFullscreen">
      <ng-container *ngIf="blocks.length">
        <ul class="pb-sidebar-list" cdkDropList (cdkDropListDropped)="moveBlocks($event)">
          <li class="pb-sidebar-list-item" *ngFor="let block of blocks; index as index" cdkDrag cdkDragLockAxis="y">
            <button class="pb-sidebar-list-item-button" (click)="selectBlock(block, index)" matRipple></button>
            <mat-icon class="pb-sidebar-list-item-icon">{{block.icon || 'tab'}}</mat-icon>
            <span class="pb-sidebar-list-item-label">{{block.label | transloco}}</span>
            <button class="pb-sidebar-list-item-visibility" mat-icon-button (click)="toggleVisible(index)">
              <mat-icon>{{block.visible ? 'visibility' : 'visibility_off'}}</mat-icon>
            </button>
            <mat-icon class="pb-sidebar-list-item-drag" cdkDragHandle>drag_indicator</mat-icon>
          </li>
        </ul>
      </ng-container>

      <button class="pb-sidebar-new" (click)="openAdd()" matRipple>
        <mat-icon class="pb-sidebar-new-icon">add</mat-icon>
        <span class="pb-sidebar-new-label">{{'PB.OPEN_ADD' | transloco}}</span>
      </button>

      <article class="pb-sidebar-add" *ngIf="state === 'add'">
        <div class="pb-sidebar-add-title">
          <span>{{'PB.OPEN_ADD' | transloco}}</span>
          <button mat-icon-button (click)="closeAdd()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div
          class="pb-sidebar-add-block"
          matRipple
          *ngFor="let block of availableBlocks; index as index"
          [class.b-dis]="isDisabled(block)"
          (click)="previewBlock(block, index)">
          {{block.label | transloco}}
          <button *ngIf="previewed === index" mat-button (jpStopPropagation)="addBlock(block)">
            {{'PB.ADD' | transloco}}
          </button>
        </div>
      </article>

    </aside>

    <header class="pb-header" [class.fullscreen]="isFullscreen">
      <span class="pb-header-space"></span>

      <mat-button-toggle-group [(value)]="view">
        <mat-button-toggle value="mobile" aria-label="Phone view">
          <mat-icon>smartphone</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="desktop" aria-label="Desktop view">
          <mat-icon>desktop_windows</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="fullscreen" aria-label="Fullscreen">
          <mat-icon>fullscreen</mat-icon>
        </mat-button-toggle>
      </mat-button-toggle-group>

      <button mat-stroked-button (click)="close()">{{'PB.CLOSE' | transloco}}</button>
    </header>

    <main class="pb-preview" [class.fullscreen]="isFullscreen">
      <div class="pb-preview-inner" [ngClass]="view">
        <ng-container #ipe></ng-container>
        <iframe id="fb-pb-iframe" #iframe></iframe>
      </div>
    </main>

    <aside class="pb-right-sidebar" [class.fullscreen]="isFullscreen" *ngIf="state === 'inner'">
      <article class="pb-sidebar-inner" *ngIf="state === 'inner'">
        <div class="pb-sidebar-inner-title">
          <span>{{selected?.label | transloco}}</span>
          <button mat-icon-button (click)="closeBlock()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <fb-pb-block
          [selected]="selected"
          [parentFormId]="cData.parentFormId"
          (remove)="removeBlock()"
          (optionsChanged)="optionsChanged($event)">
        </fb-pb-block>
      </article>
    </aside>
  </ng-container>
</section>
